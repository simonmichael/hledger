# Testing lot transfer scenarios.

# * Lot transfers

# ** 1. Simple transfer - gets ptype:transfer-from and ptype:transfer-to tags
<
2026-01-03 Transfer
    assets:broker1   -10 AAPL {$100}
    assets:broker2    10 AAPL {$100}

$ hledger -f- print --verbose-tags
2026-01-03 Transfer
    assets:broker1    -10 AAPL {$100}  ; ptype: transfer-from
    assets:broker2     10 AAPL {$100}  ; ptype: transfer-to

>=

# ** 2. Simple single-lot transfer between two broker accounts.
<
2026-01-15 buy
    assets:broker1    10 AAPL {$50}
    assets:checking

2026-02-01 transfer
    assets:broker1   -10 AAPL {$50}
    assets:broker2    10 AAPL {$50}

$ hledger -f- bal assets:broker --lots -N
             10 AAPL  assets:broker2:{2026-01-15, $50}

# ** 3. Wildcard multi-lot transfer with {}.
<
commodity AAPL  ; lots:
account assets:broker1  ; lots:
account assets:broker2  ; lots:

2026-01-15 buy cheap
    assets:broker1    10 AAPL {$50}
    assets:checking

2026-02-01 buy expensive
    assets:broker1     5 AAPL {$60}
    assets:checking

2026-03-01 transfer all
    assets:broker1   -15 AAPL {}
    assets:broker2    15 AAPL {}

$ hledger -f- bal assets:broker --lots -N
             10 AAPL  assets:broker2:{2026-01-15, $50}
              5 AAPL  assets:broker2:{2026-02-01, $60}

# ** 4. Transfer-to posting without {} is classified when commodity has lots: tag.
<
commodity AAPL  ; lots:

2026-01-15 buy
    assets:broker1    10 AAPL {$50}
    assets:checking

2026-02-01 transfer
    assets:broker1   -10 AAPL {$50}
    assets:broker2    10 AAPL

$ hledger -f- print --verbose-tags
2026-01-15 buy
    assets:broker1     10 AAPL {$50}  ; ptype: acquire
    assets:checking

2026-02-01 transfer
    assets:broker1    -10 AAPL {$50}  ; ptype: transfer-from
    assets:broker2           10 AAPL  ; ptype: transfer-to

>=

# ** 5. Transfer-to posting without {} is classified when account has lots: tag.
<
account assets:broker2  ; lots:

2026-01-15 buy
    assets:broker1    10 AAPL {$50}
    assets:checking

2026-02-01 transfer
    assets:broker1   -10 AAPL {$50}
    assets:broker2    10 AAPL

$ hledger -f- print --verbose-tags
2026-01-15 buy
    assets:broker1     10 AAPL {$50}  ; ptype: acquire
    assets:checking

2026-02-01 transfer
    assets:broker1    -10 AAPL {$50}  ; ptype: transfer-from
    assets:broker2           10 AAPL  ; ptype: transfer-to

>=

# ** 6. Transfer then dispose from new account.
<
2026-01-15 buy
    assets:broker1    10 AAPL {$50}
    assets:checking

2026-02-01 transfer
    assets:broker1   -10 AAPL {$50}
    assets:broker2    10 AAPL {$50}

2026-03-01 sell from broker2
    assets:broker2    -5 AAPL {$50} @ $70
    assets:cash       $350
    revenue:gains   -$100

$ hledger -f- bal assets:broker --lots -N
              5 AAPL  assets:broker2:{2026-01-15, $50}

# ** 7. Transfer with matching cost basis on transfer-to (validation passes).
<
2026-01-15 buy
    assets:broker1    10 AAPL {$50}
    assets:checking

2026-02-01 transfer
    assets:broker1   -10 AAPL {$50}
    assets:broker2    10 AAPL {$50}

$ hledger -f- bal assets:broker --lots -N
             10 AAPL  assets:broker2:{2026-01-15, $50}

# ** 8. Transfer with mismatched cost basis on transfer-to is an error.
<
2026-01-15 buy
    assets:broker1    10 AAPL {$50}
    assets:checking

2026-02-01 transfer
    assets:broker1   -10 AAPL {$50}
    assets:broker2    10 AAPL {$60}

$ hledger -f- bal assets:broker --lots
>2 /does not match transfer-to cost basis/
>=1

# ** 9. Transfer without prior acquisition is an error.
<
2026-02-01 transfer
    assets:broker1   -10 AAPL {$50}
    assets:broker2    10 AAPL {$50}

$ hledger -f- bal assets:broker --lots
>2 /no lots available/
>=1

# ** 10. Split transfers (1 from at qty 10, 2 to at qty 5) are not detected as transfers
# because transfer detection requires exact quantity matching. The postings are classified
# as dispose + acquire + acquire, and the transaction is unbalanced.
<
2026-01-15 buy
    assets:broker1    10 AAPL {$50}
    assets:checking

2026-02-01 split transfer
    assets:broker1   -10 AAPL {$50}
    assets:broker2     5 AAPL {$50}
    assets:broker3     5 AAPL {$50}

$ hledger -f- bal assets:broker --lots
>2 /unbalanced/
>=1

# ** 11. Cross-account transfer with fee: only matching-quantity postings are transfers.
<
commodity A  ; lots:

2026-01-15 buy
    assets:a    1 A {$100}
    assets:cash

2026-02-17 transfer with fee
    assets:a       -1 A {$100}
    assets:b        1 A {$100}
    assets:a    -0.02 A {$100}
    expenses:fees  $2

$ hledger -f- print --verbose-tags date:2026-02-17
2026-02-17 transfer with fee
    assets:a            -1 A {$100}  ; ptype: transfer-from
    assets:b             1 A {$100}  ; ptype: transfer-to
    assets:a         -0.02 A {$100}  ; ptype: dispose
    expenses:fees                $2

>=

# ** 12. Same-account transfer with fee: quantity matching pairs the transfer postings.
<
commodity A  ; lots:

2026-01-15 buy
    assets:cc    1 A {$100}
    assets:cash

2026-02-17 reclassify with fee
    assets:cc       -1 A
    assets:cc        1 A
    assets:cc    -0.02 A
    expenses:fees  $2

$ hledger -f- print --verbose-tags date:2026-02-17
2026-02-17 reclassify with fee
    assets:cc                -1 A  ; ptype: transfer-from
    assets:cc                 1 A  ; ptype: transfer-to
    assets:cc             -0.02 A  ; ptype: dispose
    expenses:fees              $2

>=
