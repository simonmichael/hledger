# * include directive

# ** 1. The old !include spelling still works.
<
!include a.j
$ hledger -f- print
2025-01-01 a

>=

# ** 2. journal, timeclock, and timedot files can be included.
# Trailing whitespace or comments are ignored.
# The order of includes is respected.
<
include b.j  
include b.timeclock ; comment
include b.timedot
 ; comment

$ hledger -f - print
2016-01-01
    (b)               1

2016-01-01 * 12:00-16:00
    (b:bb)           4.00h

2016-01-01 *
    (b.bb)            1.00

>=

# ** 3. A leading tilde is expanded to $HOME.
<
include ~/a.j
$  HOME="$PWD" hledger -f - print
2025-01-01 a

>= 0

# ** 4. include followed by whitespace and/or comment -> missing argument error
<
include  ;just a comment
$ hledger -f- print
>2 /include needs a.*argument/
>=1

# ** 5. include followed by nothing at all -> missing argument error
<
include
$ hledger -f- print
>2 /include needs a.*argument/
>=1

# ** 6. include a nonexistent file -> no files matched error
<
include nosuchfile
$ hledger -f- print
>2 /No files were matched/
>=1

# ** 7. Including a directory literally -> no files matched error
<
include glob-deep
$ hledger -f- print
>2 /No files were matched/
>=1

# ** 8. Include invalid glob patterns -> invalid glob error
<
include [.journal
$ hledger -f - print
>2 /Invalid glob/
>= 1

# ** 9. Three or more *'s -> invalid glob error
<
include ***
$ hledger -f- files
>2 /Invalid glob/
>=1

# ** 10. Including the current file literally -> cycle error.
$ hledger -f self.j files
>2 /included file forms a cycle/
>=1

# ** 11. Including a multi-file cycle, all literally -> cycle error.
$ hledger -f cycle/cycle.j files
>2 /included file forms a cycle/
>=1

# ** 12. Including the current file via glob -> harmless, globs ignore current file.
$ hledger -f glob-self.j files | sed -E 's|.*hledger/test/journal/include/||'
glob-self.j

# ** 13. Including a cycle, involving globs -> cycle error
$ hledger -f cycle/globcycle.j files
>2 /cycle/
>=1

# ** 14. Old-style deep glob **/*.j -> all non-dot .j files in current dir or non-dot subdirs.
<
include glob-deep/**/*.j
$ hledger -f - files | sed -E 's|.*/glob-deep/|glob-deep/|'
-
glob-deep/a.j
glob-deep/b/b.j
glob-deep/b/bb/bb.j
glob-deep/c/c.j
glob-deep/b/b.j
glob-deep/b/bb/bb.j
glob-deep/c/c.j

# ** 15. Simpler deep glob **.j -> same as above.
<
include glob-deep/**/*.j
$ hledger -f - files | sed -E 's|.*/glob-deep/|glob-deep/|'
-
glob-deep/a.j
glob-deep/b/b.j
glob-deep/b/bb/bb.j
glob-deep/c/c.j
glob-deep/b/b.j
glob-deep/b/bb/bb.j
glob-deep/c/c.j

# ** 16. --old-glob preserves pre-1.50 glob behaviour: avoiding dot things at top (.c/) and bottom (b/.d.j),
# but searching intermediate dot dirs (b/.e/).
<
include glob-dot/**.j
$ hledger -f - files --old-glob | sed -E 's|.*/glob-dot/||'
-
a.j
b/.e/e.j
b/b.j

# ** 17. Otherwise, globs avoid all paths involving dot dirs (.c/, b/.d.j, b/.e/) (a workaround).
<
include glob-dot/**.j
$ hledger -f - files | sed -E 's|.*/glob-dot/||'
-
a.j
b/b.j

# ** 18. A non-glob path can match dot things.
<
include glob-dot/.c/c.j
include glob-dot/b/.d.j
include glob-dot/b/.e/e.j
$ hledger -f - files | sed -E 's|.*/glob-dot/||'
-
.c/c.j
b/.d.j
b/.e/e.j

# ** 19. A glob follows a symlink to a regular file (and shows the target file's path).
$ hledger -f glob-symlinked-file/a.j files | sed -E 's|.*/glob-symlinked-file/||'
a.j
c.j

# ** 20. A glob follows a symlink to a regular dir.
$ hledger -f glob-symlinked-dir/a.j files | sed -E 's|.*/glob-symlinked-dir/||'
a.j
c/c.j

# ** 21. A glob follows a symlink to a dot file.
$ hledger -f glob-symlinked-dotfile/a.j files | sed -E 's|.*/glob-symlinked-dotfile/||'
a.j
.c.j

# ** 22. A glob does not follow a symlink to a dot dir.
$ hledger -f glob-symlinked-dotdir/a.j files | sed -E 's|.*/glob-symlinked-dotdir/||'
>2 /No files were matched by glob pattern/
#>=1  # sed hides this

# ** 23. A glob does follow a symlink to a dot dir if --old-glob is used.
$ hledger -f glob-symlinked-dotdir/a.j files --old-glob | sed -E 's|.*/glob-symlinked-dotdir/||'
a.j
.c/c.j
