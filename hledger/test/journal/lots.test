# An overview of lot functional tests:
# 1. This file covers basic input/output of lot syntax.
# 2. lots-*-entries.test cover basic lot posting classification and calculation, for many journal entry variants.
# 3. lots-*.test cover more complex lot scenarios.

# * Reading and writing lot syntax

# ** 1. Ledger-style lot syntax is parsed and printed in consolidated format.
<
2026-01-01
    assets:investment    10 AAPL @ $100 {$100} [2026-01-01] (lot A)
    assets:cash

$ hledger -f- print
2026-01-01
    assets:investment    10 AAPL {2026-01-01, "lot A", $100} @ $100
    assets:cash

>=

# ** 2. hledger consolidated lot syntax {DATE, COST} is accepted in input.
<
2026-01-01
    assets:investment    10 AAPL {2026-01-01, $100}
    assets:cash

$ hledger -f- print
2026-01-01
    assets:investment    10 AAPL {2026-01-01, $100}
    assets:cash

>=

# ** 3. hledger consolidated lot syntax with label {DATE, "LABEL", COST}.
<
2026-01-01
    assets:investment    10 AAPL {2026-01-01, "lot A", $100}
    assets:cash

$ hledger -f- print
2026-01-01
    assets:investment    10 AAPL {2026-01-01, "lot A", $100}
    assets:cash

>=

# ** 4. Partial: date only.
<
2026-01-01
    assets:investment    10 AAPL {2026-01-01}
    assets:cash

$ hledger -f- print
2026-01-01
    assets:investment    10 AAPL {2026-01-01}
    assets:cash

>=

# ** 5. Partial: label only.
<
2026-01-01
    assets:investment    10 AAPL {"lot1"}
    assets:cash

$ hledger -f- print
2026-01-01
    assets:investment    10 AAPL {"lot1"}
    assets:cash

>=

# ** 6. Consolidated with @ transacted cost.
<
2026-01-01
    assets:broker    10 AAPL {2026-01-01, $100} @ $150
    assets:cash

$ hledger -f- print
2026-01-01
    assets:broker    10 AAPL {2026-01-01, $100} @ $150
    assets:cash

>=

# ** 7. Consolidated with --lots pipeline.
<
2026-01-15 buy
    assets:stocks    10 AAPL {2026-01-15, $50}
    assets:checking

$ hledger -f- bal assets:stocks --lots -N
             10 AAPL  assets:stocks:{2026-01-15, $50}

# ** 8. Consolidated syntax rejects trailing [DATE].
<
2026-01-01
    assets:broker    10 AAPL {2026-01-01, $100} [2026-01-01]
    assets:cash

$ hledger -f- print
>2 /cannot be combined/
>=1

# ** 9. Empty cost basis annotations like {} are also preserved in print output.
<
2026-01-01
    assets:broker    10 AAPL {}
    assets:cash

$ hledger -f- print
2026-01-01
    assets:broker      10 AAPL {}
    assets:cash

>=

# ** 10. print's json output shows lot info in the acostbasis field.
$ hledger -f- print -O json
[
  {
    "tcode": "",
    "tcomment": "",
    "tdate": "2026-01-01",
    "tdate2": null,
    "tdescription": "",
    "tindex": 1,
    "tpostings": [
      {
        "paccount": "assets:broker",
        "pamount": [
          {
            "acommodity": "AAPL",
            "acost": null,
            "acostbasis": {
              "cbCost": null,
              "cbDate": null,
              "cbLabel": null
            },
            "aquantity": {
              "decimalMantissa": 10,
              "decimalPlaces": 0,
              "floatingPoint": 10
            },
            "astyle": {
              "ascommodityside": "R",
              "ascommodityspaced": true,
              "asdecimalmark": ".",
              "asdigitgroups": null,
              "asprecision": 0,
              "asrounding": "NoRounding"
            }
          }
        ],
        "pbalanceassertion": null,
        "pcomment": "",
        "pdate": null,
        "pdate2": null,
        "poriginal": null,
        "preal": "RealPosting",
        "pstatus": "Unmarked",
        "ptags": [
          [
            "_ptype",
            "acquire"
          ]
        ],
        "ptransaction_": "1"
      },
      {
        "paccount": "assets:cash",
        "pamount": [
          {
            "acommodity": "AAPL",
            "acost": null,
            "acostbasis": {
              "cbCost": null,
              "cbDate": null,
              "cbLabel": null
            },
            "aquantity": {
              "decimalMantissa": -10,
              "decimalPlaces": 0,
              "floatingPoint": -10
            },
            "astyle": {
              "ascommodityside": "R",
              "ascommodityspaced": true,
              "asdecimalmark": ".",
              "asdigitgroups": null,
              "asprecision": 0,
              "asrounding": "NoRounding"
            }
          }
        ],
        "pbalanceassertion": null,
        "pcomment": "",
        "pdate": null,
        "pdate2": null,
        "poriginal": null,
        "preal": "RealPosting",
        "pstatus": "Unmarked",
        "ptags": [],
        "ptransaction_": "1"
      }
    ],
    "tprecedingcomment": "",
    "tsourcepos": [
      {
        "sourceColumn": 1,
        "sourceLine": 1,
        "sourceName": "-"
      },
      {
        "sourceColumn": 1,
        "sourceLine": 4,
        "sourceName": "-"
      }
    ],
    "tstatus": "Unmarked",
    "ttags": []
  }
]

# ** 11. print's beancount output shows lot info with Beancount lot syntax.
<
2026-01-01 Buy stocks with full lot info
    assets:investment    10 AAPL {$150} [2026-01-01] (lot1)
    assets:cash

2026-01-02 Buy stocks with cost and date only
    assets:investment    5 TSLA {$200} [2026-01-02]
    assets:cash

2026-01-03 Buy stocks with date only
    assets:investment    3 MSFT [2026-01-03]
    assets:cash

2026-01-04 Buy stocks with label only
    assets:investment    2 GOOG (lot4)
    assets:cash

$ hledger -f- print -O beancount
;option "inferred_tolerance_default" "*:0.005"
2026-01-01 open Assets:Cash
2026-01-01 open Assets:Investment

2026-01-01 * "Buy stocks with full lot info"
    Assets:Investment    10 AAPL {150 USD, 2026-01-01, "lot1"}
    Assets:Cash

2026-01-02 * "Buy stocks with cost and date only"
    Assets:Investment    5 TSLA {200 USD, 2026-01-02}
    Assets:Cash

2026-01-03 * "Buy stocks with date only"
    Assets:Investment    3 MSFT {2026-01-03}
    Assets:Cash

2026-01-04 * "Buy stocks with label only"
    Assets:Investment    2 GOOG {"lot4"}
    Assets:Cash

>=

# ** 12. In beancount output, an account's lots: tag value becomes the account's booking method
<
account assets:broker  ; lots: FIFO

2026-01-08 Buy stock
    assets:broker     10 AAPL {$100}
    assets:cash     -$1000

$ hledger -f- print -O beancount
;option "inferred_tolerance_default" "*:0.005"
2026-01-08 open Assets:Broker "FIFO"
2026-01-08 open Assets:Cash

2026-01-08 * "Buy stock"
    Assets:Broker    10 AAPL {100 USD}
    Assets:Cash              -1000 USD

>=

# ** 13. In beancount output, balance assignment amounts are always made explicit.
<
2026-01-01 * opening balances
    equity:opening
    assets:cash    = 2000 USD

$ hledger -f- print -O beancount
;option "inferred_tolerance_default" "*:0.005"
2026-01-01 open Assets:Cash
2026-01-01 open Equity:Opening

2026-01-01 * "opening balances"
    Equity:Opening
    Assets:Cash           2000 USD

>=

# ** 14. Most other reports ignore cost basis by default
<
2026-01-01 Buy with transaction cost
    assets:broker    10 AAPL @ $160
    assets:cash

2026-01-02 Buy with cost basis
    assets:broker    10 AAPL {$150}
    assets:cash

$ hledger -f- bal assets:broker
             20 AAPL  assets:broker
--------------------
             20 AAPL  

