# Testing lot disposal scenarios.

# * Lot disposal

# ** 1. Simple dispose - negative amount to Asset account with cost basis - gets ptype:dispose tag
<
2026-01-02 Sell stock
    assets:broker    -5 AAPL {$100}
    assets:cash       $500

$ hledger -f- print --verbose-tags
2026-01-02 Sell stock
    assets:broker    -5 AAPL {$100}  ; ptype: dispose
    assets:cash                $500

>=

# ** 2. Simple single-lot disposal: the sell posting selects the appropriate lot subaccount.
<
2026-01-15 buy
    assets:stocks    10 AAPL {$50}
    assets:checking

2026-02-01 sell
    assets:stocks    -5 AAPL {$50} @ $50
    assets:cash       $250

$ hledger -f- bal assets:stocks --lots -N
              5 AAPL  assets:stocks:{2026-01-15, $50}

# ** 3. Full lot consumption: the lot is fully consumed.
<
2026-01-15 buy
    assets:stocks    10 AAPL {$50}
    assets:checking

2026-02-01 sell all
    assets:stocks   -10 AAPL {$50} @ $50
    assets:cash       $500

$ hledger -f- bal assets:stocks --lots -N

# ** 4. FIFO multi-lot disposal: sell with {} can select multiple lots, oldest first.
<
2026-01-15 buy cheap
    assets:stocks    10 AAPL {$50}
    assets:checking

2026-02-01 buy expensive
    assets:stocks    10 AAPL {$60}
    assets:checking

2026-03-01 sell some
    assets:stocks   -15 AAPL {} @ $55
    assets:cash      $825
    revenue:gains   -$25

$ hledger -f- bal assets:stocks --lots -N
              5 AAPL  assets:stocks:{2026-02-01, $60}

# ** 5. Insufficient lots error: disposing more than is available at the specified cost fails.
<
2026-01-15 buy
    assets:stocks    10 AAPL {$50}
    assets:checking

2026-02-01 sell too many
    assets:stocks   -15 AAPL {$50} @ $55
    assets:cash      $825

$ hledger -f- bal assets:stocks --lots
>2 /insufficient lots/
>=1

# ** 6. Disposing when there's no lots at all gives a different error, apparently. ?
<
2026-02-01 sell without buying
    assets:stocks    -5 AAPL {$50} @ $55
    assets:cash       $275

$ hledger -f- bal assets:stocks --lots
>2 /no lots available/
>=1

# ** 7. Multiple disposals reduce lots correctly.
<
2026-01-15 buy
    assets:stocks    10 AAPL {$50}
    assets:checking

2026-02-01 sell some
    assets:stocks    -3 AAPL {$50} @ $50
    assets:cash       $150

2026-02-15 sell more
    assets:stocks    -4 AAPL {$50} @ $50
    assets:cash       $200

2026-03-01 sell rest
    assets:stocks    -3 AAPL {$50} @ $50
    assets:cash       $150

$ hledger -f- bal assets:stocks --lots -N

# ** 8. A dispose posting with unknown transacted cost (selling price) is an error.
<
2026-01-15 buy
    assets:stocks    10 AAPL {$50}
    assets:checking

2026-02-01 sell
    assets:stocks    -5 AAPL {$50}
    assets:cash

$ hledger -f- bal assets:stocks --lots
>2 /no transacted price/
>=1

# ** 9. Explicit lot subaccount on dispose posting is accepted when it matches the resolved lot.
<
commodity AAPL  ; lots:

2026-01-15 buy
    assets:stocks    10 AAPL {} @ $50
    assets:checking

2026-02-01 sell
    assets:stocks:{2026-01-15, $50}    -5 AAPL {2026-01-15, $50} @ $60
    assets:cash      $300
    revenue:gains   -$50

$ hledger -f- print --lots
2026-01-15 buy
    assets:stocks:{2026-01-15, $50}    10 AAPL {$50} @ $50
    assets:checking

2026-02-01 sell
    assets:stocks:{2026-01-15, $50}    -5 AAPL {2026-01-15, $50} @ $60
    assets:cash                                                   $300
    revenue:gains                                                 $-50

>=

# ** 10. Explicit lot subaccount that doesn't match the resolved lot is an error.
<
commodity AAPL  ; lots:

2026-01-15 buy
    assets:stocks    10 AAPL {} @ $50
    assets:checking

2026-02-01 sell
    assets:stocks:{2026-02-01, $99}    -5 AAPL {2026-01-15, $50} @ $60
    assets:cash      $300
    revenue:gains   -$50

$ hledger -f- print --lots
>2 /conflicting cost basis date/
>=1

# ** 11. Implicit multi-lot disposal: bare negative amount with no cost basis, sale price inferred from cash.
<
commodity AAPL  ; lots:

2026-01-15 buy cheap
    assets:stocks    10 AAPL {} @ $50
    assets:checking

2026-02-01 buy expensive
    assets:stocks    10 AAPL {} @ $55
    assets:checking

2026-03-01 sell some
    assets:stocks   -15 AAPL
    assets:cash      $900
    revenue:gains

$ hledger -f- print --lots -x desc:sell
2026-03-01 sell some
    assets:stocks:{2026-01-15, $50}    -10 AAPL {2026-01-15, $50} @ $60
    assets:stocks:{2026-02-01, $55}     -5 AAPL {2026-02-01, $55} @ $60
    assets:cash                                                    $900
    revenue:gains                                                 $-125

>=

# ** 12. Implicit multi-lot disposal: negative amount with explicit @ cost, cash and gains inferred.
<
commodity AAPL  ; lots:

2026-01-15 buy cheap
    assets:stocks    10 AAPL {} @ $50
    assets:checking

2026-02-01 buy expensive
    assets:stocks    10 AAPL {} @ $55
    assets:checking

2026-03-01 sell
    assets:stocks   -15 AAPL @ $60
    assets:cash
    revenue:gains

$ hledger -f- print --lots -x desc:sell
2026-03-01 sell
    assets:stocks:{2026-01-15, $50}    -10 AAPL {2026-01-15, $50} @ $60
    assets:stocks:{2026-02-01, $55}     -5 AAPL {2026-02-01, $55} @ $60
    assets:cash                                                    $900
    revenue:gains                                                 $-125

>=

# ** 11. Bare negative lotful posting without selling price passes through with --lots
# (no error, not processed as a lot posting).
<
commodity AAPL  ; lots:

2026-01-15 buy
    assets:stocks    10 AAPL {$50}
    assets:cash

2026-02-01 gift given
    assets:stocks    -5 AAPL
    equity:opening

$ hledger -f- bal assets:stocks --lots -N
             -5 AAPL  assets:stocks
             10 AAPL  assets:stocks:{2026-01-15, $50}

# ** 13. Balance assertion on a multi-lot disposal is moved to a generated parent-account
# posting with subaccount-inclusive checking (=*), so the assertion still passes on re-read.

<
2026-01-15 buy cheap
    assets:stocks    10 AAPL {$50}
    assets:checking

2026-02-01 buy expensive
    assets:stocks    10 AAPL {$60}
    assets:checking

2026-03-01 sell all
    assets:stocks    -20 AAPL {} @ $70 = 0 AAPL
    assets:cash       $1400

$ hledger -f- print --lots -x desc:sell
2026-03-01 sell all
    assets:stocks:{2026-01-15, $50}    -10 AAPL {2026-01-15, $50} @ $70
    assets:stocks:{2026-02-01, $60}    -10 AAPL {2026-02-01, $60} @ $70
    assets:stocks                                                0 AAPL =* 0 AAPL
    assets:cash                                                   $1400
    revenue:gains                                                 $-300

>=

# ** 14. A balance assertion on a dispose posting is moved to a generated parent-account
# posting with subaccount-inclusive checking (=*).
# Here after selling lot1, assets:stocks:{2026-01-15, $50} is 0 but assets:stocks:{2026-02-01, $60} is 10 AAPL.
# The assertion = 10 AAPL, converted to =*, checks the inclusive balance of assets:stocks = 10 AAPL.
<
2026-01-15 buy lot1
    assets:stocks    10 AAPL {$50}
    assets:checking

2026-02-01 buy lot2
    assets:stocks    10 AAPL {$60}
    assets:checking

2026-03-01 sell lot1
    assets:stocks    -10 AAPL {} @ $70 = 10 AAPL
    assets:cash       $700

$ hledger -f- --lots check assertions

# ** 15. But if a lot subaccount is written explicitly, a balance assertion checks that subaccount's balance.
<
2026-01-15 buy lot1
    assets:stocks:{2026-01-15, $50}    10 AAPL
    assets:checking

2026-02-01 buy lot2
    assets:stocks:{2026-02-01, $60}    10 AAPL
    assets:checking

2026-03-01 sell lot1
    assets:stocks:{2026-01-15, $50}    -10 AAPL = 0 AAPL
    assets:cash       $700

$ hledger -f- check assertions

# ** 16. Round-trip: print --lots -x output can be re-read and balance assertions still pass.
# The generated parent-account posting with =* preserves the assertion's semantics.
<
2026-01-15 buy cheap
    assets:stocks    10 AAPL {$50}
    assets:checking

2026-02-01 buy expensive
    assets:stocks    10 AAPL {$60}
    assets:checking

2026-03-01 sell all
    assets:stocks    -20 AAPL {} @ $70 = 0 AAPL
    assets:cash       $1400

$ hledger -f- print --lots -x | hledger -f- check assertions

# ** 17. Dispose with explicit lot subaccount infers cost basis from account name.
<
commodity AAPL  ; lots:

2026-01-15 buy
    assets:stocks    10 AAPL {$50}
    assets:cash

2026-02-01 sell with explicit lot subaccount
    assets:stocks:{2026-01-15, $50}    -5 AAPL @ $60
    assets:cash
    revenue:gains

$ hledger -f- print --lots -x desc:sell
2026-02-01 sell with explicit lot subaccount
    assets:stocks:{2026-01-15, $50}    -5 AAPL {2026-01-15, $50} @ $60
    assets:cash                                                   $300
    revenue:gains                                                 $-50

>=

